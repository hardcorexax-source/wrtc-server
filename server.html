<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Peer (Initiator)</title>
</head>
<body>
    <h2>Server Peer (Initiator)</h2>
    <div id="status">Initializing...</div>
    <textarea id="content2user" placeholder="paste html"></textarea>
    <script>
        let pc = null;
        let dc = null;
        let socket = null;
        const content = document.querySelector("#content2user");
        const status = document.getElementById('status');

        const config = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        function sendContent() {
            if (dc && dc.readyState === 'open') {
                dc.send(content.value);
                console.log('Sent content:', content.value);
            }
        }

        function initPeer() {
            console.log('üöÄ Starting peer...');
            status.textContent = 'Creating peer connection...';

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –±—ã–ª–æ
            if (pc) {
                pc.close();
            }

            pc = new RTCPeerConnection(config);

            // –°–æ–∑–¥–∞—ë–º data channel
            dc = pc.createDataChannel('content');

            // –ù–ê–ó–ù–ê–ß–ê–ï–ú –í–°–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ó–î–ï–°–¨ –û–î–ò–ù –†–ê–ó
            dc.onopen = () => {
                console.log('‚úÖ‚úÖ‚úÖ DATA CHANNEL OPENED!');
                status.textContent = 'üéâ CONNECTED!';
                sendContent(); // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ textarea
            };

            dc.onmessage = (event) => {
                console.log('üì® Received from client:', event.data);
            };

            dc.onclose = () => {
                console.log('üîå Data channel closed');
                status.textContent = 'Connection closed, reinitializing...';
                if (socket) socket.close();
                setTimeout(initPeer, 1000);
            };

            dc.onerror = (error) => {
                console.error('Data channel error:', error);
                status.textContent = 'Data channel error!';
            };

            pc.onicecandidate = (event) => {
                // –í trickle-—Ä–µ–∂–∏–º–µ candidates –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ, –Ω–æ –≤ –≤–∞—à–µ–º —Å–ª—É—á–∞–µ signaling —Å–µ—Ä–≤–µ—Ä, –≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç trickle
                // –ü–æ—ç—Ç–æ–º—É –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å, –ø–æ–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å–±–æ—Ä
                if (!event.candidate) {
                    console.log('ICE gathering complete');
                }
            };

            pc.oniceconnectionstatechange = () => {
                console.log('ICE state:', pc.iceConnectionState);
                if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'closed') {
                    status.textContent = 'Connection failed/closed, reinitializing...';
                    setTimeout(initPeer, 1000);
                }
            };

            // –°–æ–∑–¥–∞—ë–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º offer
            pc.createOffer()
                .then(offer => pc.setLocalDescription(offer))
                .then(() => {
                    console.log('üì° Generated offer:', pc.localDescription);
                    status.textContent = 'Offer generated, connecting to signaling server...';

                    socket = new WebSocket("wss://my-api-test-domen.pp.ua");

                    socket.onopen = () => {
                        console.log('‚úÖ WebSocket connected');
                        status.textContent = 'Sending offer...';

                        socket.send(JSON.stringify({
                            role: "server",
                            name: "bot_father",
                            data: pc.localDescription,
                            requestTo: "none"
                        }));

                        status.textContent = 'Offer sent! Waiting for answer...';
                    };

                    socket.onmessage = async (event) => {
                        console.log('üì• Received message:', event.data);
                        const msg = JSON.parse(event.data);

                        if (msg.data && msg.data.type === 'answer') {
                            console.log('üîÑ Received answer:', msg.data);
                            await pc.setRemoteDescription(msg.data);
                            status.textContent = 'Answer received, establishing connection...';
                        }
                    };

                    socket.onerror = (err) => {
                        console.error('‚ùå WebSocket error:', err);
                        status.textContent = 'WebSocket error!';
                    };

                    socket.onclose = () => {
                        console.log('WebSocket closed');
                    };
                })
                .catch(err => {
                    console.error('Error:', err);
                    status.textContent = 'Error: ' + err.message;
                    setTimeout(initPeer, 2000);
                });
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç
        content.addEventListener('input', () => {
            sendContent();
        });

        // –ó–∞–ø—É—Å–∫–∞–µ–º
        initPeer();
    </script>
</body>
</html>