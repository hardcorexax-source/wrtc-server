<html>
  <body>
    <style>
      #outgoing {
        width: 600px;
        word-wrap: break-word;
        white-space: normal;
      }
    </style>
    <form>
      <textarea id="incoming"></textarea>
      <button type="submit">submit</button>
    </form>
    <pre id="outgoing"></pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <script>
      const socket = new WebSocket("wss://my-api-test-domen.pp.ua");

      let p = new SimplePeer({
        initiator: false,
        trickle: false
      });

      let hasReceivedOffer = false; // ‚Üê –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π

      socket.addEventListener("open", () => {
        console.log('‚úÖ WebSocket connected');
        socket.send(JSON.stringify({
          role: "client",
          name: "bogdan",
          requestTo: "bot_father"
        }));
        console.log('üì§ Sent registration');
      });

      socket.addEventListener("message", (event) => {
        console.log('üì• Received message:', event.data);
        const msg = JSON.parse(event.data);

        if (msg.data && msg.data.type === 'offer' && !hasReceivedOffer) {
          hasReceivedOffer = true; // ‚Üê –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π offer
          console.log('üîÑ Signaling with offer:', msg.data);
          p.signal(msg.data);
        }
      });

      let answerSent = false; // ‚Üê –û—Ç–ø—Ä–∞–≤–ª—è–µ–º answer —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑

      p.on('signal', data => {
        if (data.type === 'answer' && !answerSent) {
          answerSent = true;
          console.log('üì° Generated answer:', data);
          socket.send(JSON.stringify({
            role: "client",
            name: "bogdan",
            data: data,
            requestTo: "bot_father"
          }));
          console.log('üì§ Sent answer to server');
        }
      });

      p.on('connect', () => {
        console.log('‚úÖ‚úÖ‚úÖ PEER CONNECTED!');
      });

      p.on('data', data => {
        console.log('üì® Received data:', data.toString());
        document.querySelector("body").innerHTML = data;
      });

      p.on('error', err => {
        console.error('‚ùå Peer error:', err);
      });

      socket.addEventListener('error', err => {
        console.error('‚ùå WebSocket error:', err);
      });

      if (sessionStorage.getItem("server-peer") !== undefined && sessionStorage.getItem("server-peer") !== null && sessionStorage.getItem("server-peer") !== "") {
        const old_p = JSON.parse(sessionStorage.getItem("server-peer"));
        if (p !== undefined){
          if (old_p !== p) {
            sessionStorage.setItem("server-peer", JSON.stringify(p));
          } 
        }
      } else {
        sessionStorage.setItem("server-peer", JSON.stringify(p));
      }
    </script>
  </body>
</html>